{% extends "base.html" %}
{% block title %}Home - User{% endblock %}
{% block content %}

{% if current_user.is_authenticated %}

<div class="container">
  <div class="row row-cols-1 row-cols-lg-2 g-4">

    <div class="col">
      <div class="card hover-lift rounded-4 overflow-hidden mt-4" style="height: 450px;">
        <div class="card-body" style="background-color: #F5F5F5;">
          <h1 class="card-title text-center h4 py-2">Account Metrics</h1>

          <div class="row">
            <div class="col ms-5">
              <p class="fw-bold">Balance</p>
              <p class="fs-4 fw-bold card-text">${{ "{:,.2f}".format(current_user.availableFunds) }}</p>
            </div>
            <div class="col ms-5">
              <p class="fw-bold">Return to Date</p>
              <div class="d-flex align-items-center">
                <p class="fs-5 fw-bold card-text">${{ "{:,.2f}".format(totalReturn) }}</p>
                {% if totalReturn > 0 %}
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="green" class="bi bi-chevron-double-up mb-4 mx-2" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M7.646 2.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 3.707 2.354 9.354a.5.5 0 1 1-.708-.708z"/>
                    <path fill-rule="evenodd" d="M7.646 6.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 7.707l-5.646 5.647a.5.5 0 0 1-.708-.708z"/>
                  </svg>
                {% elif totalReturn < 0 %}
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#8C1D40" class="bi bi-chevron-double-down mb-4 mx-2" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1.646 6.646a.5.5 0 0 1 .708 0L8 12.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/>
                    <path fill-rule="evenodd" d="M1.646 2.646a.5.5 0 0 1 .708 0L8 8.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/>
                  </svg> 
                {% endif %}
              </div>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col ms-5">
              <p class="fw-bold" style="color: #484848;">Account Value</p> 
              <p class="fs-5 fw-bold card-text" style="color: #484848;">${{ "{:,.2f}".format(accountValue) }}</p>
            </div>
            <div class="col ms-5">
              <p class="fw-bold" style="color: #484848;">Total Contributions</p> 
              <p class="fs-5 fw-bold card-text" style="color: #484848;">${{ "{:,.2f}".format(contributions) }}</p>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col ms-5">
              <a href="{{ url_for('depositFunds') }}" class="btn btn-primary fs-5" style="background-color: #8C1D40; border: none; width: 75%;">Deposit</a>
            </div>
            <div class="col ms-5">
              <a href="{{ url_for('withdrawFunds') }}" class="btn btn-primary fs-5" style="background-color: #8C1D40; border: none; width: 75%;">Withdraw</a>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col ms-5">
              <a href="{{ url_for('buyStock') }}" class="btn btn-primary fs-5" style="background-color: #8C1D40; border: none; width: 75%;">Buy</a>
            </div>
            <div class="col ms-5">
              <a href="{{ url_for('sellStock') }}" class="btn btn-primary fs-5" style="background-color: #8C1D40; border: none; width: 75%;">Sell</a>
            </div>
          </div>

        </div>
      </div>      
    </div>

    <div class="col">
      <div class="card hover-lift rounded-4 overflow-hidden mt-4" style="height: 450px;">
        <div class="card-body" style="background-color: #F5F5F5;">
          <h1 class="card-title text-center h4 py-2">Portfolio Visualization</h1>

          <div class="d-flex justify-content-center align-items-center" style="height: 350px;">
            <canvas id="portfolioView"></canvas>
          </div>

        </div>
      </div>      
    </div>

    <div class="col">
      <div class="card hover-lift rounded-4 overflow-hidden mt-1" style="height: 450px;">
        <div class="card-body" style="background-color: #F5F5F5;">
          <h1 class="card-title text-center h4 py-2">Available Stock (Live Feed)</h1>


          <div style="height: 350px; overflow-y: auto;">
            <table class="table table-hover" id="availableStock">
              <thead>
                <tr>
                  <th scope="col" style="background-color: #F5F5F5;">Ticker</th>
                  <th scope="col" style="background-color: #F5F5F5;">Initial Price</th>
                  <th scope="col" style="background-color: #F5F5F5;">Current Price</th>
                  <th scope="col" style="background-color: #F5F5F5;">Open</th>
                  <th scope="col" style="background-color: #F5F5F5;">High</th>
                  <th scope="col" style="background-color: #F5F5F5;">Low</th>
                  <th scope="col" style="background-color: #F5F5F5;">Volume</th>
                  <th scope="col" style="background-color: #F5F5F5;">Market Cap</th>
                </tr>
              </thead>
              <tbody id="available-stock-table-body">
                {% for i in stock %}
                <tr onclick="document.getElementById('ticker').value='{{ i.ticker}}';">
                  <th scope="row" style="background-color: #F5F5F5;">{{ i.ticker }}</th>
                  <td style="background-color: #F5F5F5;">${{ "{:,.2f}".format(i.initStockPrice) }}</td>
                  <td style="background-color: #F5F5F5;">${{ "{:,.2f}".format(i.currentMktPrice) }}</td>
                  <td style="background-color: #F5F5F5;">${{ "{:,.2f}".format(i.dailyOpenPrice or 0) }}</td>
                  <td style="background-color: #F5F5F5;">${{ "{:,.2f}".format(i.dailyHighPrice or 0) }}</td>
                  <td style="background-color: #F5F5F5;">${{ "{:,.2f}".format(i.dailyLowPrice or 0) }}</td>
                  <td style="background-color: #F5F5F5;">{{ i.volume or 0 }}</td>
                  <td style="background-color: #F5F5F5;">
                    {% if i.currentMktPrice and i.company.stockTotalQty %}
                      ${{ "{:,.0f}".format(i.currentMktPrice * i.company.stockTotalQty) }}
                    {% else %}
                      $0
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
      </div>      
    </div>

    <div class="col">
      <div class="card hover-lift rounded-4 overflow-hidden mt-1" style="height: 450px;">
        <div class="card-body" style="background-color: #F5F5F5;">
          <h1 class="card-title text-center h4 py-2">Holdings</h1>

          <div style="max-height: 350px; overflow-y: auto;">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th scope="col" style="background-color: #F5F5F5;">Ticker</th>
                  <th scope="col" style="background-color: #F5F5F5;">Current Price</th>
                  <th scope="col" style="background-color: #F5F5F5;">Owned Shares</th>
                </tr>
              </thead>
              <tbody>
                {% for i in portfolio %}
                <tr onclick="document.getElementById('ticker').value='{{ i.ticker}}';">
                  <th scope="row" style="background-color: #F5F5F5;">{{ i.ticker }}</th>
                  <td style="background-color: #F5F5F5;">${{ "{:,.2f}".format(i.mktPrice) }}</td>
                  <td style="background-color: #F5F5F5;">{{ i.quantity }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
      </div>      
    </div>

  </div>
</div>


          <script>
            function updateAvailableStockPrices() {
    fetch('/api/stock_prices')
      .then(response => response.json())
      .then(data => {
        const tbody = document.getElementById('available-stock-table-body');
        if (!tbody) return;

        tbody.innerHTML = '';

        data.forEach(function (row) {
          
          const initPrice    = Number(row.initStockPrice    ?? 0);
          const currentPrice = Number(row.currentMktPrice   ?? 0);
          const openPrice    = Number(row.dailyOpenPrice    ?? initPrice);
          const highPrice    = Number(row.dailyHighPrice    ?? currentPrice);
          const lowPrice     = Number(row.dailyLowPrice     ?? currentPrice);
          const volume       = Number(row.volume            ?? 0);
          const marketCap    = Number(row.marketCap         ?? 0);

          tbody.innerHTML += `
            <tr onclick="document.getElementById('ticker').value='${row.ticker}';">
              <th scope="row" style="background-color: #F5F5F5;">${row.ticker}</th>
              <td style="background-color: #F5F5F5;">$${initPrice.toFixed(2)}</td>
              <td style="background-color: #F5F5F5;">$${currentPrice.toFixed(2)}</td>
              <td style="background-color: #F5F5F5;">$${openPrice.toFixed(2)}</td>
              <td style="background-color: #F5F5F5;">$${highPrice.toFixed(2)}</td>
              <td style="background-color: #F5F5F5;">$${lowPrice.toFixed(2)}</td>
              <td style="background-color: #F5F5F5;">${volume.toLocaleString()}</td>
              <td style="background-color: #F5F5F5;">$${marketCap.toLocaleString()}</td>
            </tr>`;
        });
      })
      .catch(err => {
        console.error('Error updating available stock prices:', err);
      });
  }

  updateAvailableStockPrices();

  setInterval(updateAvailableStockPrices, 15000);
</script>

<script>
  const chartArea = document.getElementById('portfolioView');

  const labels = {{ pieLabels | tojson }};
  const data = {{ pieData | tojson }};

  Chart.defaults.font.family = 'Inter';
  Chart.defaults.font.size = 16;

  new Chart(chartArea, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: [
          '#BFBFBF',
          '#FFC627',
          '#8C1D40'
        ]
      }]
    }
  })
</script>
{% endif %}
{% endblock %}
