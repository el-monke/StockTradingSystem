{% extends "base.html" %}
{% block title %}Change Market Settings{% endblock %}

{% block content %}

<div class="container my-5">
  <div class="row justify-content-center mt-5">
    <div class="col-12 col-lg-8">
      <div class="card hover-lift rounded-4 overflow-hidden mt-5">
        <div class="card-body" style="background-color: #F5F5F5; color:#212529;">

          <h1 class="card-title text-center h4 fw-bolder py-2 text-dark">Change Market Hours</h1>

          <form action="{{ url_for('changeMktHrs') }}" method="post" id="mktHrsForm">

            <!-- SELECT DATE -->
            <div class="mt-4 mb-3 px-4">
              <h6 class="fw-bolder text-dark mb-3">Select a Date</h6>

              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label fw-bold text-dark" for="year">Year</label>
                  <select id="year" name="year" class="form-select"
                          style="background-color:#F5F5F5; border:none; color:#212529;">
                    {% for y in range(2025, 2028) %}
                      <option value="{{ y }}">{{ y }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label fw-bold text-dark" for="month">Month</label>
                  <select id="month" name="month" class="form-select"
                          style="background-color:#F5F5F5; border:none; color:#212529;">
                    <option value="01">Jan</option>
                    <option value="02">Feb</option>
                    <option value="03">Mar</option>
                    <option value="04">Apr</option>
                    <option value="05">May</option>
                    <option value="06">Jun</option>
                    <option value="07">Jul</option>
                    <option value="08">Aug</option>
                    <option value="09">Sep</option>
                    <option value="10">Oct</option>
                    <option value="11">Nov</option>
                    <option value="12">Dec</option>
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label fw-bold text-dark" for="day">Day</label>
                  <select id="day" name="day" class="form-select"
                          style="background-color:#F5F5F5; border:none; color:#212529;">
                    {% for d in range(1, 32) %}
                      <option value="{{ "%02d"|format(d) }}">{{ d }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <input type="hidden" id="selected_date" name="selected_date">

              <p class="mt-3 mb-0 fw-bold text-dark">
                Chosen date: <strong id="datePreview">—</strong>
              </p>

              <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" value="on" id="close_market" name="close_market">
                <label class="form-check-label fw-bold text-dark" for="close_market">
                  Confirm closing market.
                </label>
              </div>

              <div class="mt-2">
                <label for="close_reason" class="form-label fw-bold text-dark">
                  Please Give a Reason for closing the Market
                </label>
                <input type="text"
                       id="close_reason"
                       name="close_reason"
                       class="form-control"
                       style="background-color:#F5F5F5; border:none; color:#212529;"
                       placeholder="e.g. Holiday, Maintenance">
              </div>
            </div>

            <hr class="my-4">

            <!-- MARKET HOURS -->
            <div class="mb-3 px-4">

              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label fw-bold text-dark" for="dayOfWeek">Choose the day of the week</label>
                  <select id="dayOfWeek" name="dayOfWeek"
                          class="form-select"
                          style="background-color:#F5F5F5; border:none; color:#212529;">
                    <option value="">-- Pick a day --</option>
                    <option value="Mon">Mon</option>
                    <option value="Tue">Tue</option>
                    <option value="Wed">Wed</option>
                    <option value="Thu">Thu</option>
                    <option value="Fri">Fri</option>
                    <option value="Sat">Sat</option>
                    <option value="Sun">Sun</option>
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label fw-bold text-dark" for="startTime">Market Open Time</label>
                  <input type="time"
                         id="startTime"
                         name="startTime"
                         class="form-control"
                         style="background-color:#F5F5F5; border:none; color:#212529;"
                         value="{{ market_start|default('07:30') }}">
                </div>

                <div class="col-md-4">
                  <label class="form-label fw-bold text-dark" for="endTime">Market Closed Time</label>
                  <input type="time"
                         id="endTime"
                         name="endTime"
                         class="form-control"
                         style="background-color:#F5F5F5; border:none; color:#212529;"
                         value="{{ market_end|default('16:00') }}">
                </div>
              </div>

              <div class="form-text" style="color:#555;">
                Market time is 7:30 AM to 4:00 PM
              </div>
            </div>

            <!-- BUTTONS -->
            <div class="d-flex justify-content-end gap-3 mt-4 mb-2 px-4">
              <button type="submit"
                      class="btn btn-primary rounded-3 fs-5 fw-bold"
                      style="background-color:#8C1D40; color:#F5F5F5; border:none;">
                Confirm
              </button>

              <button type="submit"
                      name="action"
                      value="clear_all"
                      class="btn btn-primary rounded-3 fs-5 fw-bold"
                      style="background-color:#8C1D40; color:#F5F5F5; border:none;"
                      onclick="return confirm('Are you sure you want to clear all market closures? This will open the market on all previously closed dates.');">
                Open Market
              </button>
            </div>

          </form>

          <!-- SCHEDULED CLOSURES LIST -->
          <div class="mt-5 px-4">
            <h5 class="fw-bolder text-dark mb-3">Scheduled Market Closures</h5>

            {% if exceptions %}
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle">
                <thead class="table-light">
                  <tr>
                    <th class="fw-bold text-dark">Date</th>
                    <th class="fw-bold text-dark">Reason</th>
                  </tr>
                </thead>
                <tbody>
                  {% for ex in exceptions %}
                  <tr>
                    <td>
                      {{ ex.holidayDate.strftime("%Y-%m-%d") if ex.holidayDate else "" }}
                    </td>
                    <td>{{ ex.reason or "—" }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p class="text-muted mb-0">No scheduled market closures.</p>
            {% endif %}
          </div>

        </div>
      </div>
    </div>
  </div>
</div>


<script>
  var yearSel = document.getElementById("year");
  var monthSel = document.getElementById("month");
  var daySel = document.getElementById("day");
  var hiddenDate = document.getElementById("selected_date");
  var preview = document.getElementById("datePreview");

  function updateDate() {
    if (!yearSel || !monthSel || !daySel || !hiddenDate || !preview) return;
    var iso = yearSel.value + "-" + monthSel.value + "-" + daySel.value;
    hiddenDate.value = iso;
    preview.textContent = iso;
  }

  yearSel.addEventListener("change", updateDate);
  monthSel.addEventListener("change", updateDate);
  daySel.addEventListener("change", updateDate);
  updateDate();

  var closeCheckbox = document.getElementById("close_market");
  var startTimeInput = document.getElementById("startTime");
  var endTimeInput = document.getElementById("endTime");
  var reasonInput = document.getElementById("close_reason");

  function toggleTimeAndReason() {
    var isClosing = closeCheckbox.checked;
    startTimeInput.disabled = isClosing;
    endTimeInput.disabled = isClosing;
    reasonInput.disabled = !isClosing;
  }

  closeCheckbox.addEventListener("change", toggleTimeAndReason);
  toggleTimeAndReason();
</script>

{% endblock %}
