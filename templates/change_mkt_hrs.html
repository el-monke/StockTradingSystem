{% extends "base.html" %}
{% block title %}Change Market Settings{% endblock %}

{% block content %}

<div>
  <div>
    <div>
      <div>
        <h5>Change Market Hours</h5>
        
        <!-- add button open market -->
         
        <div style="margin-bottom: 20px; padding: 15px; border: 2px solid #28a745; border-radius: 5px; background-color: #d4edda;">
          <h6>Quick Actions</h6>
          <form method="POST" action="{{ url_for('changeMktSchedule') }}" onsubmit="return confirm('Are you sure you want to clear all market closures? This will open the market on all previously closed dates.');">
            <input type="hidden" name="action" value="clear_all">
            <button type="submit" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;"> Open Market (Clear All Closures)
            </button>
          </form>
        </div>

        <!-- add button open market -->
        
        <form action="{{ url_for('changeMktHrs') }}" method="post">

          <div>
            <div>
              <h6>Select a Date</h6>
              <div>
                <input
                  type="date"
                  id="selected_date"
                  name="selected_date"
                  value="{{ selected_date|default('', true) }}"
                  aria-describedby="selectedDateHelp">
                <div id="selectedDateHelp">
                  Chosen date: <strong id="datePreview">{{ selected_date or '—' }}</strong>
                </div>

                <div>
                  <input type="checkbox" value="on" id="close_market" name="close_market">
                  <label for="close_market">
                    Confirm closing market.
                  </label>
                </div>

                <div>
                  <label for="close_reason">Reason for Closing Market</label>
                  <input type="text" id="close_reason" name="close_reason" placeholder="e.g. Independence Day">
                  <div>Enabled once box is checked</div>
                </div>
              </div>
            </div>

            <div>
              <h6>Select Days to Close Market</h6>
              {% set weekdays = [('mon','Mon'),('tue','Tue'),('wed','Wed'),('thu','Thu'),('fri','Fri'),('sat','Saturday'),('sun','Sunday')] %}
              <div class="weekDays-selector">
                {% for id, label in weekdays %}
                <div>
                  <input type="checkbox" id="{{ id }}" name="{{ id }}" value="{{ id }}" class="weekday">
                  <label for="{{ id }}">{{ label }}</label>
                </div>
                {% endfor %}
              </div>
              <div>
                Selected Days:
                <strong id="daysPreview">
                  {% if selected_days %}{{ selected_days|join(', ') }}{% else %}None{% endif %}
                </strong>
              </div>

              <div>
                <label for="startTime">Open Time</label>
                <input type="time" id="startTime" name="startTime"
                       value="{{ market_start|default('07:30') }}">
              </div>

              <div>
                <label for="endTime">Close Time</label>
                <input type="time" id="endTime" name="endTime"
                       value="{{ market_end|default('16:00') }}">
              </div>

              <div>
                All times are in 24 hour format (07:30 - 16:00).
              </div>
            </div>
          </div>

          <div>
            <button type="submit">Confirm</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const dateInput = document.getElementById('selected_date');
    const datePreview = document.getElementById('datePreview');
    const fmt = d => d ? new Date(d).toLocaleDateString() : '—';
    if (dateInput && datePreview) {
      datePreview.textContent = fmt(dateInput.value);
      dateInput.addEventListener('input', () => datePreview.textContent = fmt(dateInput.value));
    }

    const daysPreview = document.getElementById('daysPreview');
    const boxes = Array.from(document.querySelectorAll('.weekDays-selector input.weekday'));
    function updateDays() {
      const map = {mon:'Mon', tue:'Tue', wed:'Wed', thu:'Thu', fri:'Friday', sat:'Saturday', sun:'Sunday'};
      const selected = boxes.filter(b => b.checked).map(b => map[b.value]);
      daysPreview.textContent = selected.length ? selected.join(', ') : 'None';
    }
    boxes.forEach(b => b.addEventListener('change', updateDays));
    updateDays();

    const closeChk = document.getElementById('close_market');
    const start = document.getElementById('startTime');
    const end = document.getElementById('endTime');
    const reason = document.getElementById('close_reason');
    function toggleTimeFields() {
      const dis = closeChk.checked;
      start.disabled = dis;
      end.disabled = dis;
      reason.disabled = !dis;
    }
    closeChk.addEventListener('change', toggleTimeFields);
    toggleTimeFields();
  })();
</script>

{% endblock %}
