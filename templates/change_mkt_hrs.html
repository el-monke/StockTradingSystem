{# change_mkt_hrs.html #}
{% extends "base.html" %}
{% block title %}Change Market Settings{% endblock %}

{% block content %}

<div>
  <div>
    <div>
      <div>
        <h5>Change Market Hours</h5>

        
        <div style="margin-bottom: 20px; padding: 15px; border: 2px solid #28a745; border-radius: 5px; background-color: #d4edda;">
          <h6>Quick Actions</h6>
          <form method="POST"
                action="{{ url_for('changeMktHrs') }}"
                onsubmit="return confirm('Are you sure you want to clear all market closures? This will open the market on all previously closed dates.');">
            <input type="hidden" name="action" value="clear_all">
            <button type="submit"
                    style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
              Open Market (Clear All Closures)
            </button>
          </form>
        </div>

        <form action="{{ url_for('changeMktHrs') }}" method="post">

        
          <div>
            <div>
              <h6>Select a Date</h6>
              <div>

                
                <label>Year:
                  <select id="year" name="year">
                    {% for y in range(2020, 2031) %}
                      <option value="{{ y }}">{{ y }}</option>
                    {% endfor %}
                  </select>
                </label>

                <label>Month:
                  <select id="month" name="month">
                    <option value="01">Jan</option>
                    <option value="02">Feb</option>
                    <option value="03">Mar</option>
                    <option value="04">Apr</option>
                    <option value="05">May</option>
                    <option value="06">Jun</option>
                    <option value="07">Jul</option>
                    <option value="08">Aug</option>
                    <option value="09">Sep</option>
                    <option value="10">Oct</option>
                    <option value="11">Nov</option>
                    <option value="12">Dec</option>
                  </select>
                </label>

                <label>Day:
                  <select id="day" name="day">
                    {% for d in range(1, 32) %}
                      <option value="{{ "%02d"|format(d) }}">{{ d }}</option>
                    {% endfor %}
                  </select>
                </label>

                <input type="hidden" id="selected_date" name="selected_date">

                <p>Chosen date: <strong id="datePreview">â€”</strong></p>

                <div>
                  <input type="checkbox" value="on" id="close_market" name="close_market">
                  <label for="close_market">
                    Confirm closing market.
                  </label>
                </div>

                <div>
                  <label for="close_reason">Reason for Closing Market</label>
                  <input type="text" id="close_reason" name="close_reason" placeholder="e.g. Independence Day">
                  <div>Enabled once box is checked</div>
                </div>
              </div>
            </div>

            <div>
              <h6>Select Day & Market Hours</h6>

              <label for="dayOfWeek">Day of Week</label>
              <select id="dayOfWeek" name="dayOfWeek">
                <option value="">-- Pick a day --</option>
                <option value="Mon">Mon</option>
                <option value="Tue">Tue</option>
                <option value="Wed">Wed</option>
                <option value="Thu">Thu</option>
                <option value="Fri">Fri</option>
                <option value="Sat">Sat</option>
                <option value="Sun">Sun</option>
              </select>

              <div>
                <label for="startTime">Open Time</label>
                <input type="time" id="startTime" name="startTime"
                       value="{{ market_start|default('07:30') }}">
              </div>

              <div>
                <label for="endTime">Close Time</label>
                <input type="time" id="endTime" name="endTime"
                       value="{{ market_end|default('16:00') }}">
              </div>

              <div>
                All times are in 24 hour format (07:30 - 16:00).
              </div>
            </div>
          </div>

          <div>
            <button type="submit">Confirm</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  var yearSel = document.getElementById("year");
  var monthSel = document.getElementById("month");
  var daySel = document.getElementById("day");
  var hiddenDate = document.getElementById("selected_date");
  var preview = document.getElementById("datePreview");

  function updateDate() {
    if (!yearSel || !monthSel || !daySel || !hiddenDate || !preview) {
      return;
    }
    var y = yearSel.value;
    var m = monthSel.value;
    var d = daySel.value;

    var iso = y + "-" + m + "-" + d; 
    hiddenDate.value = iso;
    preview.textContent = iso;
  }

  if (yearSel && monthSel && daySel) {
    yearSel.addEventListener("change", updateDate);
    monthSel.addEventListener("change", updateDate);
    daySel.addEventListener("change", updateDate);
    updateDate();
  }

  var closeCheckbox = document.getElementById("close_market");
  var startTimeInput = document.getElementById("startTime");
  var endTimeInput = document.getElementById("endTime");
  var reasonInput = document.getElementById("close_reason");

  function toggleTimeAndReason() {
    if (!closeCheckbox || !startTimeInput || !endTimeInput || !reasonInput) {
      return;
    }

    var isClosing = closeCheckbox.checked;

    startTimeInput.disabled = isClosing;
    endTimeInput.disabled = isClosing;
    reasonInput.disabled = !isClosing;
  }

  if (closeCheckbox) {
    closeCheckbox.addEventListener("change", toggleTimeAndReason);
    toggleTimeAndReason();
  }
</script>

{% endblock %}
