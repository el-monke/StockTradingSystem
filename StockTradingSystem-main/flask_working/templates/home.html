{% extends "base.html" %}
{% block title %}Home - User{% endblock %}
{% block content %}

{% if current_user.is_authenticated %}

  <div>
    <div>
      <div>
        <div>
          <h5>{{ current_user.fullName }} - Dashboard</h5>

      <div>
        <div>
          <div>
            <h5>Owned Stock</h5>
            <table>
              <thead>
                <tr>
                  <th>Ticker</th>
                  <th>Mkt Price</th>
                  <th>Qty</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
                {% for i in portfolio %}
                <tr>
                  <td>{{ i.ticker }}</td>
                  <td>${{ "{:,.2f}".format(i.mktPrice) }}</td>
                  <td>{{ i.quantity }}</td>
                  <td>${{ "{:,.2f}".format(i.mktPrice * i.quantity) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div>
          <div>
            <h5>Available Stock</h5>
            <table>
              <thead>
                <tr>
                  <th>Ticker</th>
                  <th>Mkt Price</th>
                  <th>Init Price</th>
                </tr>
              </thead>
              <tbody id="available-stock-table-body">
                {% for i in stock %}
                <tr>
                  <td>{{ i.ticker }}</td>
                  <td>${{ "{:,.2f}".format(i.currentMktPrice) }}</td>
                  <td>${{ "{:,.2f}".format(i.initStockPrice) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            <script>
            function updateAvailableStockPrices() {
              fetch('/api/stock_prices')
                .then(response => response.json())
                .then(data => {
                  const tbody = document.getElementById('available-stock-table-body');
                  if (!tbody) return;

                  tbody.innerHTML = '';
                  data.forEach(function(row) {
                    tbody.innerHTML += '<tr><td>' + row.ticker +
                      '</td><td>$' + row.currentMktPrice +
                      '</td><td>$' + row.initStockPrice + '</td></tr>';
                  });
                });
              }

// run once on load
updateAvailableStockPrices();

// then every 5 seconds
setInterval(updateAvailableStockPrices, 5000);
</script>

            <h5>Balance</h5>
            <p>${{ "{:,.2f}".format(current_user.availableFunds) }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

{% else %}
  <h1>You are not logged in</h1>
{% endif %}

{% endblock %}
