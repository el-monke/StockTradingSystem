{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block content %}

{% if current_user.is_authenticated %}

  <div>
    <div>
      <div>
        <div>
          <h5>Admin Dashboard</h5>
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Account Number</th>
                <th>Balance</th>
                <th>Update/Delete</th>
              </tr>
            </thead>
            <tbody>
              {% for i in user %}
              <tr>
                <td>{{ i.fullName }}</td>
                <td>{{ i.email }}</td>
                <td>{{ i.customerAccountNumber }}</td>
                <td>${{ i.availableFunds }}</td>
                <td>
                  <a href="{{ url_for('update_user', user_id=i.userId) }}">Update</a>
                  <form method="POST" action="{{ url_for('delete_user', user_id=i.userId) }}">
                    <button type="submit">Delete</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div>
        <div>
          <div>
            <h5>Stocks</h5>
            <table>
              <thead>
                <tr>
                  <th>Ticker</th>
                  <th>Qty</th>
                  <th>Init Price</th>
                  <th>Current Price</th>
                </tr>
              </thead>
              <tbody id="stock-table-body">
                {% for i in stock %}
                <tr>
                  <td>{{ i.ticker }}</td>
                  <td>{{ i.quantity }}</td>
                  <td>${{ i.initStockPrice }}</td>
                  <td>${{ i.currentMktPrice }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            <script>
            function updateStockPrices() {
              fetch('/api/stock_prices')
                .then(response => response.json())
                .then(data => {
                  const tbody = document.getElementById('stock-table-body');
                  if (!tbody) return;
                  tbody.innerHTML = '';
                  data.forEach(function(row) {
                    tbody.innerHTML += '<tr><td>' + row.ticker + '</td><td>' +
                      row.quantity + '</td><td>$' + row.initStockPrice +
                      '</td><td>$' + row.currentMktPrice + '</td></tr>';
                  });
                });
            }
            setInterval(updateStockPrices, 5000);
            </script>

          </div>
        </div>
      </div>
    </div>
  </div>
{% else %}
  <h1>You are not logged in</h1>
{% endif %}

{% endblock %}